# 크리투스 팀 랭킹 대시보드 구축 매뉴얼

> 이 문서만 Claude Code에 전달하면, 동일한 대시보드를 처음부터 재현할 수 있다.
> 기수별로 반복 사용 가능한 구조로 설계되어 있다.

---

## 1. 준비물

| 항목 | 세부 내용 |
|------|----------|
| **Google Sheets API** | 서비스 계정 인증. `credentials.json` 경로: `~/.claude/google-sheets/credentials.json` |
| **Python 환경** | venv에 `gspread`, `google-auth` 설치 |
| **MCP 서버** | Playwright (브라우저 스크린샷 검증용) |
| **GitHub CLI (gh)** | 리포 생성 및 푸시. 계정: `creatus-team` |
| **Vercel 계정** | 정적 사이트 배포. `creatus-team` GitHub 연동 |

### 대상 스프레드시트 구조

스프레드시트에 아래 두 시트가 존재해야 한다.

**"과제 폼" 시트** (구글 폼 응답 시트):
| 열 | 내용 |
|----|------|
| C열 | 성함 (이름) |
| E열 | 톡방 알파벳 (A, B, C, D, E, F) |
| F열 | 주차 텍스트 ("1주차", "2주차" 등 포함) |

**"소그룹 배정" 시트**:
| 열 | 내용 |
|----|------|
| A열 | 이름 |
| B열 | 톡방 배정 (A, B, C, D, E, F) |

---

## 2. 구축 과정 (Step by Step)

### STEP 1. Google Sheets "점수 집계" 시트 생성 (API)

Python 스크립트로 스프레드시트에 "점수 집계" 시트를 추가하고, 수식을 입력한다.

#### 1-1. 환경 준비

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install gspread google-auth
```

#### 1-2. 스크립트 실행

```python
import gspread
from google.oauth2.service_account import Credentials

# === 설정 ===
SPREADSHEET_ID = "1dKyjPmmqtkPbkPv_ByEgQM6i3JNK2hhQ6Ej9nrQbLJw"
CREDENTIALS_PATH = "~/.claude/google-sheets/credentials.json"

# === 인증 ===
scopes = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
]
creds = Credentials.from_service_account_file(CREDENTIALS_PATH, scopes=scopes)
gc = gspread.authorize(creds)
spreadsheet = gc.open_by_key(SPREADSHEET_ID)

# === "점수 집계" 시트 추가 ===
try:
    ws = spreadsheet.worksheet("점수 집계")
    print("이미 존재하는 시트를 사용합니다.")
except gspread.exceptions.WorksheetNotFound:
    ws = spreadsheet.add_worksheet(title="점수 집계", rows=10, cols=9)
    print("점수 집계 시트를 생성했습니다.")

# === 헤더 입력 ===
headers = ["팀", "팀원수", "1주차 제출", "2주차 제출", "3주차 제출", "4주차 제출",
           "누적 개인", "누적보너스", "총점"]
ws.update("A1:I1", [headers])

# === 팀명 입력 (A~F) ===
teams = [["A"], ["B"], ["C"], ["D"], ["E"], ["F"]]
ws.update("A2:A7", teams)

# === 수식 입력 ===
# value_input_option="USER_ENTERED" 로 입력해야 수식으로 인식됨
formulas = []
for row in range(2, 8):  # 2행 ~ 7행
    cell_ref = f"A{row}"
    formulas.append([
        # B열: 팀원수
        f"=COUNTIFS('소그룹 배정'!B:B, {cell_ref})",
        # C열: 1주차 제출
        f'=IFERROR(COUNTA(UNIQUE(FILTER(\'과제 폼\'!C:C, \'과제 폼\'!E:E={cell_ref}, ISNUMBER(SEARCH("1주차", \'과제 폼\'!F:F))))), 0)',
        # D열: 2주차 제출
        f'=IFERROR(COUNTA(UNIQUE(FILTER(\'과제 폼\'!C:C, \'과제 폼\'!E:E={cell_ref}, ISNUMBER(SEARCH("2주차", \'과제 폼\'!F:F))))), 0)',
        # E열: 3주차 제출
        f'=IFERROR(COUNTA(UNIQUE(FILTER(\'과제 폼\'!C:C, \'과제 폼\'!E:E={cell_ref}, ISNUMBER(SEARCH("3주차", \'과제 폼\'!F:F))))), 0)',
        # F열: 4주차 제출
        f'=IFERROR(COUNTA(UNIQUE(FILTER(\'과제 폼\'!C:C, \'과제 폼\'!E:E={cell_ref}, ISNUMBER(SEARCH("4주차", \'과제 폼\'!F:F))))), 0)',
        # G열: 누적 개인점수 (15인 정규화)
        f"=SUM(C{row}:F{row}) * 10 * (15 / B{row})",
        # H열: 누적 보너스
        f'=COUNTIF(C{row}:F{row}, ">="&B{row}) * 100',
        # I열: 총점
        f"=G{row} + H{row}",
    ])

ws.update(f"B2:I7", formulas, value_input_option="USER_ENTERED")
print("수식 입력 완료.")
```

#### 수식 해설

| 열 | 수식 | 설명 |
|----|------|------|
| B (팀원수) | `=COUNTIFS('소그룹 배정'!B:B, A2)` | 소그룹 배정 시트에서 해당 팀에 배정된 인원 수 |
| C~F (주차별 제출) | `=IFERROR(COUNTA(UNIQUE(FILTER(...))), 0)` | 과제 폼에서 해당 팀 + 해당 주차 조건으로 필터링 후, UNIQUE로 중복 제거, COUNTA로 인원 수 카운트 |
| G (누적 개인) | `=SUM(C2:F2) * 10 * (15 / B2)` | (총 제출 건수) x 10점 x (15 / 팀원수) -- 15인 기준 정규화 |
| H (누적 보너스) | `=COUNTIF(C2:F2, ">="&B2) * 100` | 전원 제출 달성 주차 수 x 100점 |
| I (총점) | `=G2 + H2` | 개인점수 + 보너스 합산 |

---

### STEP 2. 스프레드시트 "웹에 게시" 설정

> 이 단계는 사용자가 직접 수행한다.

1. Google Sheets에서 해당 스프레드시트 열기
2. **파일 > 공유 > 웹에 게시**
3. 드롭다운에서 **"점수 집계"** 시트 선택
4. 형식: **CSV**
5. "게시" 클릭

게시 후 CSV URL 패턴:
```
https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=점수집계
```

실제 URL (1기 기준):
```
https://docs.google.com/spreadsheets/d/1dKyjPmmqtkPbkPv_ByEgQM6i3JNK2hhQ6Ej9nrQbLJw/gviz/tq?tqx=out:csv&sheet=%EC%A0%90%EC%88%98%20%EC%A7%91%EA%B3%84
```

> 주의: 시트 이름에 공백이 있으면 URL에서 `encodeURIComponent`로 인코딩해야 한다.

---

### STEP 3. 대시보드 HTML 제작

단일 파일 `dashboard/index.html`로 구성한다. CSS와 JS 모두 인라인으로 임베디드.

#### 핵심 구조

```
index.html
├── <style> ... </style>          # 다크 테마, 반응형 CSS
├── <div class="container">       # 메인 레이아웃
│   ├── .header                   # 제목 + 부제
│   ├── .update-info              # 마지막 업데이트 시간
│   ├── #app                      # 동적 렌더링 영역
│   │   ├── .top-team             # 1등 하이라이트 (왕관)
│   │   ├── .chart-section        # 수평 바 차트
│   │   └── .table-section        # 상세 순위표
│   └── .footer                   # 푸터
└── <script> ... </script>        # 데이터 fetch + 파싱 + 렌더링
```

#### CSS 변수 (팀 컬러)

```css
:root {
  --team-A: #FF6B6B;
  --team-B: #4ECDC4;
  --team-C: #45B7D1;
  --team-D: #96CEB4;
  --team-E: #FFEAA7;
  --team-F: #DDA0DD;
  --bg: #0f0f1a;
  --card-bg: #1a1a2e;
  --text: #e0e0e0;
  --text-muted: #888;
  --accent: #6c63ff;
  --bar-height: 48px;
}
```

#### JS 핵심 로직

```javascript
// === 설정 ===
const SHEET_ID = '1dKyjPmmqtkPbkPv_ByEgQM6i3JNK2hhQ6Ej9nrQbLJw';
const SHEET_NAME = '점수 집계';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

// CSV fetch -> 파싱 -> 렌더링
async function loadData() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const teams = parseCSV(text);  // 각 행을 {team, members, w1~w4, personalTotal, bonusTotal, total} 객체로 변환
  render(teams);                 // 총점 기준 내림차순 정렬 후 렌더링
}

// 초기 로드
loadData();

// 5분마다 자동 새로고침
setInterval(loadData, 5 * 60 * 1000);
```

#### CSV 파싱 주의사항

Google Sheets CSV는 값을 큰따옴표(`"`)로 감싼다. 따옴표 내부의 따옴표는 `""`로 이스케이프된다.
파싱할 때 이 규칙을 처리해야 한다.

```javascript
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];

  return lines.slice(1).map(line => {
    const cells = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        cells.push(current.trim());
        current = '';
      } else {
        current += ch;
      }
    }
    cells.push(current.trim());

    return {
      team: cells[0] || '',
      members: parseInt(cells[1]) || 0,
      w1: parseInt(cells[2]) || 0,
      w2: parseInt(cells[3]) || 0,
      w3: parseInt(cells[4]) || 0,
      w4: parseInt(cells[5]) || 0,
      personalTotal: parseFloat(cells[6]) || 0,
      bonusTotal: parseInt(cells[7]) || 0,
      total: parseFloat(cells[8]) || 0,
    };
  }).filter(row => row.team);
}
```

#### 렌더링 구성 요소

1. **1등 하이라이트**: 왕관 이모지 + 팀명 + 총점. 총점이 0이면 표시하지 않음.
2. **수평 바 차트**: 총점 기준 내림차순. 1등 대비 비율로 바 너비 결정. 바가 좁으면(15% 미만) 점수를 바 외부에 표시.
3. **상세 순위표**: 순위, 팀명(컬러 dot), 개인 점수, 보너스(횟수 배지 포함), 총점.
4. **바 애니메이션**: `requestAnimationFrame` 2단계로 width 0 -> 목표값 전환, `transition: width 1s cubic-bezier(0.22, 1, 0.36, 1)`.

#### 반응형 처리

```css
@media (max-width: 480px) {
  body { padding: 12px; }
  .header h1 { font-size: 1.4rem; }
  :root { --bar-height: 38px; }
  /* ... 패딩, 폰트 축소 등 */
}
```

#### 전체 HTML 파일

전체 코드는 `dashboard/index.html` 파일을 참조한다. 단일 파일이므로 그대로 복사하면 된다.

---

### STEP 4. GitHub 리포 생성 + 푸시

```bash
# 프로젝트 디렉토리에서 실행
cd dashboard

# git 초기화
git init
git branch -M main

# 리포 생성 (creatus-team 조직)
gh repo create creatus-team/team-ranking-dashboard --public --source=. --remote=origin

# 커밋 + 푸시
git add index.html
git commit -m "크리투스 팀 랭킹 대시보드 초기 배포"
git push -u origin main
```

---

### STEP 5. Vercel 배포

1. [vercel.com](https://vercel.com) 접속
2. "Add New Project" 클릭
3. GitHub 연동에서 `creatus-team/team-ranking-dashboard` 리포 선택
4. Framework Preset: **Other** (정적 HTML이므로)
5. "Deploy" 클릭

배포 완료 후 공개 URL:
```
https://team-ranking-dashboard.vercel.app
```

> main 브랜치에 push하면 Vercel이 자동으로 재배포한다.

---

### STEP 6. 검증

#### Playwright로 스크린샷 확인

MCP Playwright 서버를 사용하여 데스크톱/모바일 화면을 확인한다.

```
1. browser_navigate -> https://team-ranking-dashboard.vercel.app
2. browser_take_screenshot -> 데스크톱 화면 캡처
3. browser_resize -> width: 375, height: 812 (iPhone X)
4. browser_take_screenshot -> 모바일 화면 캡처
```

#### 체크리스트

- [ ] CSV fetch가 정상적으로 동작하는가 (CORS 에러 없음)
- [ ] 팀 순서가 총점 기준 내림차순으로 정렬되는가
- [ ] 바 차트의 너비가 1등 대비 비율로 올바르게 표시되는가
- [ ] 1등 팀에 왕관 하이라이트가 표시되는가
- [ ] 모바일 화면에서 레이아웃이 깨지지 않는가
- [ ] 5분 후 자동 새로고침이 동작하는가

---

## 3. 최종 상태

| 구성 요소 | 상태 |
|-----------|------|
| **Google Sheets "점수 집계" 시트** | 시트 함수만으로 자동 계산. 과제 폼에 응답이 추가되면 실시간 반영. |
| **Vercel 대시보드** | 공개 URL `https://team-ranking-dashboard.vercel.app`. 5분마다 자동 새로고침. |
| **GitHub 리포** | `creatus-team/team-ranking-dashboard` (main 브랜치) |

---

## 4. 점수 규칙

| 항목 | 점수 | 산출 방식 |
|------|------|-----------|
| **개인 제출** | 10점 x (15 / 팀원수) | 15인 기준 정규화. 팀원이 적을수록 1인당 점수 가중치가 높아짐. |
| **팀 보너스** | 100점 | 해당 주차에 톡방 전원이 과제를 제출했을 때 부여. |
| **중복 제출** | 1건만 인정 | UNIQUE 함수로 동일 인물의 같은 주차 중복 제출을 필터링. |

### 정규화 예시

- 팀원 15명: 1명 제출 = 10점
- 팀원 10명: 1명 제출 = 10 x (15/10) = 15점
- 팀원 20명: 1명 제출 = 10 x (15/20) = 7.5점

---

## 5. 기수별 운영 시 변경 포인트

현재 구조는 1기 전용이다. 새 기수를 운영할 때 변경해야 하는 부분:

### 최소 변경 (기수별 별도 시트)

1. **새 스프레드시트 생성**: "과제 폼" + "소그룹 배정" 시트 구조 동일하게
2. **STEP 1 재실행**: `SPREADSHEET_ID`만 새 값으로 교체
3. **STEP 2 재실행**: 새 시트 "웹에 게시"
4. **index.html 수정**: `SHEET_ID` 상수를 새 값으로 교체
5. **git push**: Vercel 자동 재배포

### 향후 확장 방향 (통합 구조)

- 기수별 스프레드시트를 만들지 않고, `ARRAYFORMULA` + `IMPORTRANGE`로 통합 시트에서 기수별 데이터를 가져오는 구조로 전환
- 대시보드에 기수 선택 드롭다운 추가
- URL 파라미터로 기수를 지정하면 해당 기수의 시트 데이터를 fetch하는 방식

---

## 부록: 트러블슈팅

### CSV fetch 실패 (CORS)

- "웹에 게시" 설정이 되어 있는지 확인
- 시트 이름이 정확한지 확인 (공백, 오타)
- URL에서 시트 이름이 올바르게 인코딩되었는지 확인

### 수식 에러 (#REF!, #VALUE!)

- "과제 폼", "소그룹 배정" 시트 이름이 정확히 일치하는지 확인
- 서비스 계정에 스프레드시트 편집 권한이 있는지 확인

### Vercel 배포 실패

- GitHub 리포가 public인지 확인
- Vercel 프로젝트가 올바른 리포를 가리키는지 확인
- `index.html`이 리포 루트에 있는지 확인
